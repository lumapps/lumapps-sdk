

dockerbuild: &dockerbuild
  - checkout
  - run: sudo chown -R circleci:circleci /usr/local/bin
  - run: sudo chown -R circleci:circleci /usr/local/lib/python*

  # Build
  - run:
      name: Build
      command: pip install -e . && pip install -r requirements_dev.txt  

  # # Code formatting
  # - run:
  #     name: Code formatting
  #     command: |
  #       sudo apt-get install -y software-properties-common
  #       sudo add-apt-repository -y ppa:deadsnakes/ppa 
  #       sudo apt-get update
  #       sudo apt-get -y install python3.6 
  #       python3 --version && python --version
  
  # Tests
  - run: 
      name: Test and coverage
      command: |
        mkdir test-reports
        coverage run -m pytest --junitxml=test-reports/junit.xml
        coverage report
        coverage html -d test-reports/coverage
        coverage xml -o test-reports/coverage.xml
        echo $CIRCLE_BUILD_NUM
        bash <(curl -s https://codecov.io/bash) -cF Build${CIRCLE_BUILD_NUM}
  
  # Doc
  - run:
      name: Doc build
      command: cd documentation && make clean html 

jobs:
  build-test-36:
    <<: *dockerbuild
    docker:
      - image: circleci/python:3.6
    steps:
      - run: python --version



  build-test-27:
    <<: *dockerbuild
    docker:
      - image: circleci/python:2.7


workflows:
  version: 2

  build-test:
    jobs:
      - build-test-36
      - build-test-27



          